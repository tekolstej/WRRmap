<<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Wind River Sampling Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
    }
    #map {
      height: 65vh;
    }
    #controls {
      padding: 10px 20px;
      background: #f4f4f4;
      border-bottom: 1px solid #ccc;
    }
    #table-container {
      padding: 20px;
    }
    label {
      margin-right: 10px;
    }
    select, input[type="checkbox"] {
      margin-right: 20px;
    }
    #chart-container {
      width: 100%;
      height: 35vh;
      padding: 10px 20px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="controls">
    <label for="yearFilter">Year:</label>
    <select id="yearFilter">
      <option value="">All</option>
      <option value="2024">2024</option>
      <option value="2025">2025</option>
    </select>

    <label for="regionFilter">Region:</label>
    <select id="regionFilter">
      <option value="">All</option>
      <option value="SW">SW</option>
      <option value="WC">WC</option>
      <option value="NW">NW</option>
    </select>

    <label for="speciesFilter">Species:</label>
    <select id="speciesFilter">
      <option value="">All</option>
      <option value="Lodgepole Pine">Lodgepole Pine</option>
      <option value="Aspen">Aspen</option>
      <option value="Meadow">Meadow</option>
    </select>

    <label for="elevationFilter">Elevation:</label>
    <select id="elevationFilter">
      <option value="">All</option>
      <option value="Low">Low</option>
      <option value="Mid">Mid</option>
      <option value="High">High</option>
    </select>

    <label><input type="checkbox" id="heatmapToggle"> Show Heatmap</label>

    <label for="heatmapVariable">Heatmap Variable:</label>
    <select id="heatmapVariable">
      <option value="soil_moisture">Soil Moisture</option>
      <option value="soil_temp">Soil Temp</option>
      <option value="soil_ph">Soil pH</option>
      <option value="elevation">Elevation</option>
    </select>

    <label for="xVar">X:</label>
    <select id="xVar"></select>
    <label for="yVar">Y:</label>
    <select id="yVar"></select>
  </div>

  <div id="table-container">
    <table id="dataTable" class="display"></table>
  </div>

  <div id="chart-container">
    <canvas id="chart"></canvas>
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <script>
    const map = L.map('map').setView([42.7, -109.3], 9);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const icons = {
      'Lodgepole Pine': L.icon({ iconUrl: 'icons/lp.png', iconSize: [32, 37], iconAnchor: [16, 37] }),
      'Aspen': L.icon({ iconUrl: 'icons/asp.png', iconSize: [32, 37], iconAnchor: [16, 37] }),
      'Meadow': L.icon({ iconUrl: 'icons/medo.png', iconSize: [32, 37], iconAnchor: [16, 37] })
    };

    let allData = [];
    let markerMap = {};
    let clusterGroup = L.markerClusterGroup();
    let heatLayer;
    let chart;
    let dataTable;

    function createMarker(site) {
      const lat = parseFloat(site.latitude);
      const lon = parseFloat(site.longitude);
      if (isNaN(lat) || isNaN(lon)) return null;
      const icon = icons[site.sampled] || L.Icon.Default;
      const marker = L.marker([lat, lon], { icon });
      marker.bindPopup(`<strong>${site.id}</strong><br>Species: ${site.sampled}<br>Soil pH: ${site.soil_ph}`);
      markerMap[site.id] = marker;
      return marker;
    }

    function updateHeatmap(data) {
      const variable = document.getElementById('heatmapVariable').value;
      const values = data.map(d => parseFloat(d[variable])).filter(v => !isNaN(v));
      const min = Math.min(...values), max = Math.max(...values);
      const points = data.map(site => {
        const val = parseFloat(site[variable]);
        const lat = parseFloat(site.latitude);
        const lon = parseFloat(site.longitude);
        return (!isNaN(val) && !isNaN(lat) && !isNaN(lon)) ? [lat, lon, (val - min) / (max - min)] : null;
      }).filter(Boolean);

      if (heatLayer) map.removeLayer(heatLayer);
      heatLayer = L.heatLayer(points, {
        radius: 25,
        blur: 15,
        gradient: { 0.0: 'blue', 0.5: 'lime', 0.75: 'yellow', 1.0: 'red' }
      });
      if (document.getElementById('heatmapToggle').checked) heatLayer.addTo(map);
    }

    function updateChart(data) {
      const xVar = document.getElementById('xVar').value;
      const yVar = document.getElementById('yVar').value;
      const points = data.map(d => ({ x: parseFloat(d[xVar]), y: parseFloat(d[yVar]) }))
                         .filter(p => !isNaN(p.x) && !isNaN(p.y));

      if (chart) chart.destroy();
      chart = new Chart(document.getElementById('chart'), {
        type: 'scatter',
        data: { datasets: [{ label: `${yVar} vs ${xVar}`, data: points, backgroundColor: 'orange' }] },
        options: { scales: { x: { title: { display: true, text: xVar } }, y: { title: { display: true, text: yVar } } } }
      });
    }

    function updateMapAndTable() {
      const year = document.getElementById('yearFilter').value;
      const region = document.getElementById('regionFilter').value;
      const species = document.getElementById('speciesFilter').value;
      const elevation = document.getElementById('elevationFilter').value;

      const filtered = allData.filter(site => {
        return (!year || site.date.includes(year)) &&
               (!region || site.region === region) &&
               (!species || site.sampled === species) &&
               (!elevation || site.site === elevation);
      });

      clusterGroup.clearLayers();
      filtered.map(createMarker).forEach(m => m && clusterGroup.addLayer(m));
      updateHeatmap(filtered);
      updateChart(filtered);
      dataTable.clear().rows.add(filtered).draw();
    }

    fetch('sites3.csv')
      .then(res => res.text())
      .then(csvText => {
        Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
          complete: function(results) {
            allData = results.data;
            map.addLayer(clusterGroup);
            allData.forEach(createMarker);

            const numericFields = Object.keys(allData[0]).filter(k => !isNaN(parseFloat(allData[0][k])));
            numericFields.forEach(field => {
              document.getElementById('xVar').innerHTML += `<option value="${field}">${field}</option>`;
              document.getElementById('yVar').innerHTML += `<option value="${field}">${field}</option>`;
            });

            dataTable = $('#dataTable').DataTable({
              data: allData,
              columns: Object.keys(allData[0]).map(k => ({ title: k, data: k }))
            });

            document.querySelectorAll('#speciesFilter, #elevationFilter, #heatmapToggle, #heatmapVariable, #yearFilter, #regionFilter, #xVar, #yVar')
              .forEach(el => el.addEventListener('change', updateMapAndTable));

            updateMapAndTable();
          }
        });
      });
  </script>
</body>
</html>

